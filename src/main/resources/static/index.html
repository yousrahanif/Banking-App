

<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Banking Application</title>
   <link href="/css/bootstrap.min.css" rel="stylesheet">
   <!-- SweetAlert2 CSS -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
   <style>
       body {
           /* Set background image */
           background-image: url('https://images.unsplash.com/photo-1633158829875-e5316a358c6f?q=80&w=2970&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
           /* Center and cover the background */
           background-size: cover;
           background-position: center;
           /* Set background color as fallback */
           background-color: #f8f9fa; /* Light gray color */
       }
       .balance {
           font-size: 24px;
           font-weight: bold;
           margin-bottom: 20px;
           text-align: center; /* Centering the balance display */
       }
       .app-heading {
           text-align: center;
           color: #007bff; /* Bootstrap primary color */
           margin-top: 100px; /* Adjusted margin for heading */
           margin-bottom: 30px;
       }
      .btn-group {
   text-align: center; /* Center align the button group */
   display: flex; /* Use flexbox for layout */
   justify-content: center; /* Center items horizontally */
   margin-top: 20px; /* Adjusted margin for button group */
}
.btn-group .btn {
   margin: 0 10px; /* Add some space between buttons */
   flex: 1; /* Make buttons grow to fill available space equally */
}
       .form-group {
           margin-bottom: 15px; /* Adding margin between form groups */
        
       }
        #inputUserId {
           width: 200px; /* Set a specific width for the input field */
           margin: 0 auto; /* Center the input field */
           display: block; /* Make it a block element for centering */
           font-size: 14px; /* Adjust the font size */
       }
      
       #userIdDisplay {
           display: inline-block;
           width: auto;
           border: none;
           background-color: transparent;
           font-weight: bold;
           text-align: center;
           outline: none; /* Remove outline on focus */
       }
       .welcome-text {
           color: black; /* Green color */
           font-weight: bold;
       }
       .transaction-history {
           margin-top: 30px;
           text-align: center;
       }
       .transaction-list {
           list-style-type: none;
           padding: 0;
       }
       .transaction-item {
           margin-bottom: 10px;
           border: 1px solid #ccc;
           padding: 10px;
           background-color:rgb(213, 255, 213);
       }
       .transaction-item.failed {
           background-color: #f8d7da; /* Red background color for failed transactions */
       }
       .transaction-item.success {
           background-color: green; /* Light green background color for successful transactions */
       }
 </style>
</head>
<body>
   <div class="container">
       <h1 class="app-heading welcome-text">Welcome to Your Banking App</h1>
      
       <!-- Buttons for actions: Load Funds, Authorize (Withdraw), and View Transaction History -->
      <!-- Input field for User ID -->
<div class="form-group">
   <input type="text" class="form-control" id="inputUserId" placeholder="Enter User ID">
</div>
<!-- Buttons for actions: Load Funds, Authorize (Withdraw), and View Transaction History -->
<div class="btn-group" role="group">
   <button type="button" class="btn btn-primary" id="loadButton">Load Funds</button>
   <button type="button" class="btn btn-primary" id="authButton">Authorize (Withdraw)</button>
   <button type="button" class="btn btn-primary" id="historyButton">View Transaction History</button>
<button type="button" class="btn btn-primary" id="balanceButton">View Total Balance</button>

</div>
       <!-- Load Funds Form -->
       <div id="loadForm" style="display: none;">
           <h2>Load Funds</h2>
           <form id="loadForm">
               <div class="form-group">
                   <label for="loadUserId">User ID:</label>
                   <input type="text" class="form-control" id="loadUserId" placeholder="Enter User ID">
               </div>
               <div class="form-group">
                   <label for="loadAmount">Amount:</label>
                   <input type="number" class="form-control" id="loadAmount" placeholder="Enter Amount" step="0.01">
               </div>
               <button type="submit" class="btn btn-primary">Load Funds</button>
           </form>
       </div>
       <!-- Authorize (Withdraw) Form (same as Load Funds Form) -->
      <!-- Authorize (Withdraw) Form (same as Load Funds Form) -->
<div id="authForm" style="display: none;">
   <h2>Authorize (Withdraw)</h2>
   <form id="authForm">
       <div class="form-group">
           <label for="authUserId">User ID:</label>
           <input type="text" class="form-control" id="authUserId" placeholder="Enter User ID">
       </div>
       <div class="form-group">
           <label for="authAmount">Amount:</label>
           <input type="number" class="form-control" id="authAmount" placeholder="Enter Amount" step="0.01">
       </div>
       <button type="submit" class="btn btn-primary">Authorize (Withdraw)</button>
   </form>
</div>
       <!-- Transaction History Section -->
       <div class="transaction-history" id="transactionList" style="display: none;">
           <h2>Transaction History</h2>
           <ul class="transaction-list"></ul>
       </div>
       <!-- Total Balance Section -->
     
   </div>
   <script src="/js/bootstrap.bundle.min.js"></script>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <!-- SweetAlert2 JS -->
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script>
   $(document).ready(function () {
    // Show Load Funds Form when Load Funds button is clicked
    $('#loadButton').click(function () {
        var userId = $('#inputUserId').val().trim(); // Get trimmed User ID value
        if (userId === '') {
            // Show warning if User ID field is empty
            Swal.fire({
                icon: 'warning',
                title: 'Warning',
                text: 'Please enter User ID.',
                confirmButtonColor: '#007bff'
            });
            return;
        }
        // Proceed with showing Load Funds Form
        $('#loadForm').show();
        $('#authForm').hide();
        $('#transactionList').hide();
        $('#totalBalance').show();
        // Autofill user ID and disable input field
        $('#loadUserId').val(userId).prop('disabled', true);
    });

    // Show Authorize (Withdraw) Form when Authorize button is clicked
    $('#authButton').click(function () {
        var userId = $('#inputUserId').val().trim(); // Get trimmed User ID value
        if (userId === '') {
            // Show warning if User ID field is empty
            Swal.fire({
                icon: 'warning',
                title: 'Warning',
                text: 'Please enter User ID.',
                confirmButtonColor: '#007bff'
            });
            return;
        }
        // Proceed with showing Authorize (Withdraw) Form
        $('#authForm').show();
        $('#loadForm').hide();
        $('#transactionList').hide();
        $('#totalBalance').show();
        // Autofill user ID and disable input field
        $('#authUserId').val(userId).prop('disabled', true);
    });

    // Fetch and display transaction history when View Transaction History button is clicked
    $('#historyButton').click(function () {
        var userId = $('#inputUserId').val().trim(); // Get trimmed User ID value
        if (userId === '') {
            // Show warning if User ID field is empty
            Swal.fire({
                icon: 'warning',
                title: 'Warning',
                text: 'Please enter User ID.',
                confirmButtonColor: '#007bff'
            });
            return;
        }
        // Proceed with fetching and displaying transaction history
        fetchAndDisplayTransactionHistory(userId);
        $('#transactionList').show();
        $('#loadForm').hide();
        $('#authForm').hide();
    });
           // Function to fetch and display transaction history
           function fetchAndDisplayTransactionHistory(userId) {
               $.ajax({
                   type: 'GET',
                   url: '/transaction-history?userId=' + userId,
                   success: function (data) {
                       displayTransactionHistory(data);
                       calculateTotalBalance(data);
                   },
                   error: function (xhr, status, error) {
                       console.error(xhr.responseText);
                   }
               });
           }
           // Function to display transaction history
           function displayTransactionHistory(history) {
               var transactionList = $('#transactionList');
               transactionList.empty(); // Clear existing history
               history.forEach(function (transaction) {
                   var date = new Date(transaction.timestamp);
                   var formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                   var formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric' });
                   var transactionItem = $('<li class="transaction-item"></li>').html(
                       '<strong>Type:</strong> ' + transaction.type + '<br>' +
                       '<strong>Amount:</strong> $' + transaction.amount.toFixed(2) + '<br>' +
                       '<strong>Status:</strong> ' + transaction.status + '<br>' +
                       '<strong>Date:</strong> ' + formattedDate + '<br>' +
                       '<strong>Time:</strong> ' + formattedTime
                   );
                   // Check if the transaction status is 'Failed' and add the 'failed' class accordingly
                   if (transaction.status === 'Failed') {
                       transactionItem.addClass('failed');
                   }
                   transactionList.prepend(transactionItem); // Prepend transaction item to show new history on top
               });
           }
           // Function to calculate and display the total balance
          // Function to calculate and display the total balance
function calculateTotalBalance(history) {
   var totalBalance = 0;
   if (history.length === 0) {
       // If there are no transactions, set total balance to 0
       totalBalance = 0;
   } else {
       history.forEach(function (transaction) {
           if (transaction.type === 'Load') {
               totalBalance += transaction.amount;
           } else if (transaction.type === 'Authorization' && transaction.status === 'Success') {
               totalBalance -= transaction.amount;
           }
       });
   }
   $('#totalBalanceAmount').text(totalBalance.toFixed(2));
   $('#totalBalance').show();
}
           // Load form submission
 $('#loadForm').submit(function (event) {
   event.preventDefault();
   var userId = $('#loadUserId').val();
   var amount = $('#loadAmount').val();
   // Check if fields are empty
   if (!userId || !amount) {
       Swal.fire({
           icon: 'warning',
           title: 'Warning',
           text: 'Please fill in all the fields.',
           confirmButtonColor: '#007bff'
       });
       return;
   }
   // Additional validation logic
   if (parseFloat(amount) <= 0) {
       Swal.fire({
           icon: 'warning',
           title: 'Warning',
           text: 'Amount must be greater than 0.',
           confirmButtonColor: '#007bff'
       });
       return;
   }
   // If all validations pass, proceed with AJAX request
   $.ajax({
       type: 'PUT',
       url: '/loads',
       contentType: 'application/json',
       data: JSON.stringify({ userId: userId, amount: parseFloat(amount) }),
       success: function (data) {
			
			 $('#loadAmount').val('');
			
			
           $('#balanceDisplay').html('<span class="welcome-text">User ID:</span> <span id="userIdDisplay" contenteditable="true">' + userId + '</span> | <span class="welcome-text">Current Balance:</span> $<span id="balanceAmount">' + data.toFixed(2) + '</span>');
           fetchAndDisplayTransactionHistory(userId); // Fetch and display transaction history after load
           // Display success message
           Swal.fire({
               icon: 'success',
               title: 'Success',
                text: '$' + parseFloat(amount).toFixed(2) + ' loaded successfully!',
               confirmButtonColor: '#007bff'
           });
       },
       error: function (xhr, status, error) {
           console.error(xhr.responseText);
       }
   });
});
// Authorization form submission
$('#authForm').submit(function (event) {
   event.preventDefault();
   var userId = $('#authUserId').val();
   var amount = $('#authAmount').val();
   // Check if fields are empty
   if (!userId || !amount) {
       Swal.fire({
           icon: 'warning',
           title: 'Warning',
           text: 'Please fill in all the fields.',
           confirmButtonColor: '#007bff'
       });
       return;
   }
   // Additional validation logic
   if (parseFloat(amount) <= 0) {
       Swal.fire({
           icon: 'warning',
           title: 'Warning',
           text: 'Amount must be greater than 0.',
           confirmButtonColor: '#007bff'
       });
       return;
   }
   // If all validations pass, proceed with AJAX request
   $.ajax({
       type: 'PUT',
       url: '/authorizations',
       contentType: 'application/json',
       data: JSON.stringify({ userId: userId, amount: parseFloat(amount) }),
       success: function (data) {
			
			
			$('#authAmount').val('');
			
           console.log("Authorization request successful");
           $('#balanceDisplay').html('<span class="welcome-text">User ID:</span> <span id="userIdDisplay" contenteditable="true">' + userId + '</span> | <span class="welcome-text">Current Balance:</span> $<span id="balanceAmount">' + data.toFixed(2) + '</span>');
           // Fetch and display transaction history after authorization
           fetchAndDisplayTransactionHistory(userId);
           // Display success message
           Swal.fire({
               icon: 'success',
               title: 'Success',
                text: '$' + parseFloat(amount).toFixed(2) + ' authorized successfully!',
               confirmButtonColor: '#007bff'
           });
       },
       error: function (xhr, status, error) {
           console.error(xhr.responseText);
           if (xhr.status === 400) {
               // Add failed transaction to transaction history immediately
               addToTransactionHistory(userId, amount, "Authorization", new Date(), "Failed");
               Swal.fire({
                   icon: 'error',
                   title: 'Error',
                   text: 'Insufficient balance to authorize transaction!',
                   confirmButtonColor: '#007bff'
               });
           }
       }
   });
});
           // Event listener for changes in the user ID field
           $('#userIdDisplay').on('input', function () {
               var userId = $(this).text();
               fetchAndDisplayTransactionHistory(userId);
           });
           // Fetch and display transaction history for the initial user ID
           var initialUserId = $('#userIdDisplay').text();
           fetchAndDisplayTransactionHistory(initialUserId);
       });
       
       
       
       
       // Event listener for the "View Total Balance" button
// Event listener for the "View Total Balance" button
$('#balanceButton').click(function () {
    var userId = $('#inputUserId').val().trim(); // Get trimmed User ID value
    if (userId === '') {
        // Show warning if User ID field is empty
        Swal.fire({
            icon: 'warning',
            title: 'Warning',
            text: 'Please enter User ID.',
            confirmButtonColor: '#007bff'
        });
        return;
    }
    // Proceed with calculating and displaying total balance
    calculateAndDisplayTotalBalance(userId);
});

// Function to calculate and display the total balance
function calculateAndDisplayTotalBalance(userId) {
    $.ajax({
        type: 'GET',
        url: '/total-balance?userId=' + userId, // Assuming there's an endpoint to fetch total balance
        success: function (totalBalance) {
            // Display total balance using SweetAlert
            Swal.fire({
                icon: 'info',
                title: 'Total Balance',
                text: 'Your total balance is $' + totalBalance.toFixed(2),
                confirmButtonColor: '#007bff'
            });
        },
        error: function (xhr, status, error) {
            console.error(xhr.responseText);
        }
    });
}

       
       
       // Function to add failed authorization transaction to transaction history
       function addToTransactionHistory(userId, amount, type, timestamp, status) {
           var transactionList = $('#transactionList');
           var date = new Date(timestamp);
           var formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
           var formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric' });
           var transactionItem = $('<li class="transaction-item failed"></li>').html(
               '<strong>Type:</strong> ' + type + '<br>' +
               '<strong>Amount:</strong> $' + parseFloat(amount).toFixed(2) + '<br>' +
               '<strong>Status:</strong> ' + status + '<br>' +
               '<strong>Date:</strong> ' + formattedDate + '<br>' +
               '<strong>Time:</strong> ' + formattedTime
           );
           transactionList.prepend(transactionItem); // Add failed transaction to the beginning of the transaction history
       }
   </script>
</body>
</html>