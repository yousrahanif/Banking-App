<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking Application</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        .balance {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center; /* Centering the balance display */
        }
        .app-heading {
            text-align: center;
            color: #007bff; /* Bootstrap primary color */
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px; /* Adding margin between form groups */
        }
        #userIdDisplay {
            display: inline-block;
            width: auto;
            border: none;
            background-color: transparent;
            font-weight: bold;
            text-align: center;
            outline: none; /* Remove outline on focus */
        }
        .welcome-text {
            color: #28a745; /* Green color */
            font-weight: bold;
        }
        .transaction-history {
            margin-top: 30px;
            text-align: center;
        }
        .transaction-list {
            list-style-type: none;
            padding: 0;
        }
        .transaction-item {
            margin-bottom: 10px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .transaction-item.failed {
            background-color: #f8d7da; /* Red background color for failed transactions */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="app-heading welcome-text">Welcome to Your Banking App</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h2>Load Funds</h2>
                <form id="loadForm">
                    <div class="form-group">
                        <label for="loadUserId">User ID:</label>
                        <input type="text" class="form-control" id="loadUserId" placeholder="Enter User ID" >
                    </div>
                    <div class="form-group">
                        <label for="loadAmount">Amount:</label>
                        <input type="number" class="form-control" id="loadAmount" placeholder="Enter Amount" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary">Load Funds</button>
                </form>
            </div>
            <div class="col-md-6">
                <h2>Authorize Transaction</h2>
                <form id="authForm">
                    <div class="form-group">
                        <label for="authUserId">User ID:</label>
                        <input type="text" class="form-control" id="authUserId" placeholder="Enter User ID">
                    </div>
                    <div class="form-group">
                        <label for="authAmount">Amount:</label>
                        <input type="number" class="form-control" id="authAmount" placeholder="Enter Amount" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary">Authorize Transaction</button>
                </form>
            </div>
        </div>
        
        <div class="balance" id="balanceDisplay">
            <!-- Balance display remains the same -->
        </div>

        <!-- Transaction History Section -->
        <div class="transaction-history">
            <h2>Transaction History</h2>
            <ul class="transaction-list" id="transactionList"></ul>
        </div>
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Function to fetch and display transaction history
            function fetchAndDisplayTransactionHistory(userId) {
                $.ajax({
                    type: 'GET',
                    url: '/transaction-history?userId=' + userId,
                    success: function (data) {
                        displayTransactionHistory(data);
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            }

            // Function to display transaction history
           // Function to display transaction history
function displayTransactionHistory(history) {
    var transactionList = $('#transactionList');
    transactionList.empty(); // Clear existing history

    history.forEach(function (transaction) {
        var date = new Date(transaction.timestamp);
        var formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        var formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric' });

        var transactionItem = $('<li class="transaction-item"></li>').html(
            '<strong>Type:</strong> ' + transaction.type + '<br>' +
            '<strong>Amount:</strong> $' + transaction.amount.toFixed(2) + '<br>' +
            '<strong>Status:</strong> ' + transaction.status + '<br>' +
            '<strong>Date:</strong> ' + formattedDate + '<br>' +
            '<strong>Time:</strong> ' + formattedTime
        );

        // Check if the transaction status is 'Failed' and add the 'failed' class accordingly
        if (transaction.status === 'Failed') {
            transactionItem.addClass('failed');
        }

        transactionList.append(transactionItem);
    });
}


            // Load form submission
            $('#loadForm').submit(function (event) {
                event.preventDefault();
                var userId = $('#loadUserId').val();
                var amount = $('#loadAmount').val();

                // Check if fields are empty
                if (!userId || !amount) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning',
                        text: 'Please fill in all the fields.',
                        confirmButtonColor: '#007bff'
                    });
                    return;
                }

                // Additional validation logic
                if (parseFloat(amount) < 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning',
                        text: 'You are trying to load a negative amount. If you want to withdraw funds, please use the authorization form.',
                        confirmButtonColor: '#007bff'
                    });
                    return;
                }

                // If all validations pass, proceed with AJAX request
                $.ajax({
                    type: 'PUT',
                    url: '/loads',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId: userId, amount: parseFloat(amount) }),
                    success: function (data) {
                        $('#balanceDisplay').html('<span class="welcome-text">User ID:</span> <span id="userIdDisplay" contenteditable="true">' + userId + '</span> | <span class="welcome-text">Current Balance:</span> $<span id="balanceAmount">' + data.toFixed(2) + '</span>');
                        fetchAndDisplayTransactionHistory(userId); // Fetch and display transaction history after load
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                    }
                });
            });

            // Authorization form submission
           // Authorization form submission
// Authorization form submission
// Authorization form submission
// Authorization form submission
$('#authForm').submit(function (event) {
    event.preventDefault();
    var userId = $('#authUserId').val();
    var amount = $('#authAmount').val();

    // Check if fields are empty
    if (!userId || !amount) {
        Swal.fire({
            icon: 'warning',
            title: 'Warning',
            text: 'Please fill in all the fields.',
            confirmButtonColor: '#007bff'
        });
        return;
    }

    // Additional validation logic
    if (parseFloat(amount) < 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Warning',
            text: 'You cannot use a negative value for authorization.',
            confirmButtonColor: '#007bff'
        });
        return;
    }

    // If all validations pass, proceed with AJAX request
    $.ajax({
        type: 'PUT',
        url: '/authorizations',
        contentType: 'application/json',
        data: JSON.stringify({ userId: userId, amount: parseFloat(amount) }),
        success: function (data) {
            console.log("Authorization request successful");
            $('#balanceDisplay').html('<span class="welcome-text">User ID:</span> <span id="userIdDisplay" contenteditable="true">' + userId + '</span> | <span class="welcome-text">Current Balance:</span> $<span id="balanceAmount">' + data.toFixed(2) + '</span>');

            // Fetch and display transaction history after authorization
            fetchAndDisplayTransactionHistory(userId);
        },
        error: function (xhr, status, error) {
            console.error(xhr.responseText);
            if (xhr.status === 400) {
                // Add failed transaction to transaction history only if it's not already there
                if ($('.transaction-item.failed').length === 0) {
                    addToTransactionHistory(userId, amount, "Authorization", new Date(), "Failed");
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Insufficient balance to authorize transaction!',
                    confirmButtonColor: '#007bff'
                });
            }
        }
    });
});


            // Event listener for changes in the user ID field
            $('#userIdDisplay').on('input', function () {
                var userId = $(this).text();
                fetchAndDisplayTransactionHistory(userId);
            });

            // Fetch and display transaction history for the initial user ID
            var initialUserId = $('#userIdDisplay').text();
            fetchAndDisplayTransactionHistory(initialUserId);
        });

        // Function to add failed authorization transaction to transaction history
        function addToTransactionHistory(userId, amount, type, timestamp, status) {
            var transactionList = $('#transactionList');

            var date = new Date(timestamp);
            var formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            var formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric' });

            var transactionItem = $('<li class="transaction-item failed"></li>').html(
                '<strong>Type:</strong> ' + type + '<br>' +
                '<strong>Amount:</strong> $' + parseFloat(amount).toFixed(2) + '<br>' +
                '<strong>Status:</strong> ' + status + '<br>' +
                '<strong>Date:</strong> ' + formattedDate + '<br>' +
                '<strong>Time:</strong> ' + formattedTime
            );

            transactionList.prepend(transactionItem); // Add failed transaction to the beginning of the transaction history
        }
    </script>

</body>
</html>
